<!DOCTYPE html>
<html>
<head>

    <!--bootstrap-->
    <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap-theme.min.css">
    <script src="bower_components/jquery/dist/jquery.min.js"></script>
    <script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

    <!--angular and jquery-->
    <script src="bower_components/angular/angular.min.js"></script>

    <!--spinkit-->
    <link rel="stylesheet" href="bower_components/angular-spinkit/build/angular-spinkit.min.css">
    <script src="bower_components/angular-spinkit/build/angular-spinkit.min.js"></script>

    <!--chart(chart.js)-->
    <script src="bower_components/Chart.js/Chart.min.js"></script>
    <script src="bower_components/angular-chart.js/dist/angular-chart.min.js"></script>
    <link rel="stylesheet" href="bower_components/angular-chart.js/dist/angular-chart.css"/>

    <!--chart(nwagon)-->
    <link rel="stylesheet" href="bower_components/Nwagon/Nwagon.css" type="text/css">
    <script src="bower_components/Nwagon/Nwagon.js"></script>

    <!--style-->
    <link rel="stylesheet" href="stylesheets/style.css">



</head>
<body ng-cloak ng-app="sentimeter" ng-controller="view">
<!--FFDC74-->

<div id="header">
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container-fluid">
            <div class="navbar-header">
                <a class="navbar-brand" href="/home">
                    <img src="image/logo.png" width="150">
                </a>
            </div>
            <div>
                <ul class="nav navbar-nav navbar-right">
                    <form class="navbar-form" role="search">
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="Search" ng-model="input"
                                   ng-keyup="$event.keyCode == 13 && toggle()">

                            <div class="input-group-btn">
                                <button class="btn btn-default" ng-click="toggle()" type="submit">
                                    <i class="glyphicon glyphicon-search"></i></button>
                            </div>
                        </div>
                    </form>
                </ul>
            </div>
        </div>
        <div class="well well-lg vw-container-header-well" ng-hide="erroralert">
            <h4>
                <small style="color:#72848B;">총 {{model.sentiment.totalCount}}개의 글의</small>
                "{{keyword}}"에 대한 감성분석 결과입니다.
            </h4>
        </div>
        <div class="well well-lg vw-container-header-error-well" ng-show="erroralert">
            <h4>"{{keyword}}"에 대한 글이 없습니다. 다른 키워드를 입력해주세요.</h4>
        </div>
        <div class="vw-container-header-keyword">
            <h5 style="color:#72848B">많이 검색한 키워드:
                <small ng-repeat="keyword in model.search">
                    <a href="/view?keyword={{keyword._id}}"
                       style="font-size:12px; padding-left:1em; color:#696969">{{keyword._id}}</a>
                </small>
            </h5>
        </div>
    </nav>
</div>


<!--<div id="refresher">-->
<div id="container">
    <div class="vw-container-hide"
         ng-class="{ 'vw-container-hide-active' : getSentimentBar && getWordCount && getChart}">
        <div class="outer">
            <div class="inner">
                <div class="centered">
                    <h3 style="color:#72848B;">감성분석을 하는 중 입니다</h3>
                    <!--<fading-circle-spinner></fading-circle-spinner>-->
                    <!--<pulse-spinner></pulse-spinner>-->
                    <!--<chasing-dots-spinner></chasing-dots-spinner>-->
                    <three-bounce-spinner></three-bounce-spinner>
                </div>
            </div>
        </div>
    </div>

    <div class="vw-container" ng-hide="">
        <div class="vw-container-header">
        </div>
        <div class="">
            <div class="vw-container-sentimentBar">
                <h4><span class="glyphicon glyphicon-ok"></span> 감성분석결과</h4>

                <div class="progress progress-striped">
                    <div class="progress-bar progress-bar-positive progress-bar-striped" role="progressbar"
                         aria-valuenow="60" aria-valuemin="0" aria-valuemax="100"
                         style="width: {{model.sentiment.positive}}%;">
                        <span>{{model.sentiment.positive}}%</span>
                    </div>
                    <div class="progress-bar progress-bar-neutral progress-bar-striped" role="progressbar"
                         aria-valuenow="60" aria-valuemin="0" aria-valuemax="100"
                         style="width: {{model.sentiment.neutral}}%;">
                        <span>{{model.sentiment.neutral}}%</span>
                    </div>
                    <div class="progress-bar progress-bar-negative progress-bar-striped" role="progressbar"
                         aria-valuenow="60" aria-valuemin="0" aria-valuemax="100"
                         style="width: {{model.sentiment.negative}}%;">
                        <span>{{model.sentiment.negative}}%</span>
                    </div>
                </div>

            </div>
            <div class="vw-container-analysis">
                <div class="vw-container-analysis-chart">
                    <h4><span class="glyphicon glyphicon-stats"></span> 일주일 분포</h4>
                    <!--<div id="chart18"></div>-->
                    <canvas id="bar" class="chart chart-bar" chart-data="data" chart-labels="labels"
                            chart-series="series" chart-options="options" width="601" height="300"></canvas>
                </div>

                <div class="vw-container-analysis-word">
                    <h4><span class="glyphicon glyphicon-menu-hamburger"></span> 단어</h4>
                    <table class="table">
                        <thead>
                        <tr>
                            <th>단어</th>
                            <th>횟수</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr ng-repeat="word in model.word" style="{{word.style}}">
                            <td>{{word.word}}</td>
                            <td>{{word.count}}</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="vw-container-sns">
                <h4><span class="glyphicon glyphicon-search"></span> 게시글</h4>

                <ul class="nav nav-pills">
                    <li class="active">
                        <a ng-click="selectCategory()" data-toggle="pill" href="#home">전체
                            <small style="color:#72848B;">{{model.sentiment.totalCount}}</small>
                        </a>
                    </li>
                    <li>
                        <a ng-click="selectCategory('긍정')" data-toggle="pill" href="#pos">긍정
                            <small style="color:#72848B;">{{model.sentiment.positiveCount}}</small>
                        </a>
                    </li>
                    <li>
                        <a ng-click="selectCategory('중립')" data-toggle="pill" href="#neu">중립
                            <small style="color:#72848B;">{{model.sentiment.neutralCount}}</small>
                        </a>
                    </li>
                    <li>
                        <a ng-click="selectCategory('부정')" data-toggle="pill" href="#neg">부정
                            <small style="color:#72848B;">{{model.sentiment.negativeCount}}</small>
                        </a>
                    </li>
                </ul>

                <div class="tab-content">
                    <div id="home" class="tab-pane fade in active">
                        <ul class="list-group">
                            <li ng-repeat="article in model.sentiment.text | filter:categoryFilterFn | range:articleSize"
                                class="list-group-item">
                                <span style="color:#F17233">{{article.name}}
                                  <small style="color:#72848B">@{{article.scrName}}</small>
                                    <small style="color:#C6C6C6; padding-left:1em;">{{article.date}}</small>
                                </span>
                                <br>
                                <a style="color:#000000;" href="{{article.URL}}">{{article.Text}}</a>
                            </li>
                            <a href="" ng-show="ShowMoreButton()" ng-click="clickCategory()"
                               class="list-group-item list-group-item-warning" style="text-align: center;">더보기</a>
                        </ul>
                    </div>
                    <div id="pos" class="tab-pane fade">
                        <ul class="list-group">
                            <li ng-repeat="article in model.sentiment.text | filter:categoryFilterFn | range:articleSize"
                                class="list-group-item">
                        <span style="color:#F17233">{{article.name}}
                            <small style="color:#72848B">@{{article.scrName}}</small>
                            <small style="color:#C6C6C6; padding-left:1em;">{{article.date}}</small></span>
                                <br>
                                <a style="color:#000000;" href="{{article.URL}}">{{article.Text}}</a>
                            </li>
                            <a href="" ng-show="ShowMoreButton()" ng-click="clickCategory()"
                               class="list-group-item list-group-item-warning" style="text-align: center;">더보기</a>
                        </ul>
                    </div>
                    <div id="neu" class="tab-pane fade">
                        <ul class="list-group">
                            <li ng-repeat="article in model.sentiment.text | filter:categoryFilterFn | range:articleSize"
                                class="list-group-item">
                        <span style="color:#F17233">{{article.name}}
                            <small style="color:#72848B">@{{article.scrName}}</small>
                            <small style="color:#C6C6C6; padding-left:1em;">{{article.date}}</small></span>
                                <br>
                                <a style="color:#000000;" href="{{article.URL}}">{{article.Text}}</a>
                            </li>
                            <a href="" ng-show="ShowMoreButton()" ng-click="clickCategory()"
                               class="list-group-item list-group-item-warning" style="text-align: center;">더보기</a>
                        </ul>
                    </div>
                    <div id="neg" class="tab-pane fade">
                        <ul class="list-group">
                            <li ng-repeat="article in model.sentiment.text | filter:categoryFilterFn | range:articleSize"
                                class="list-group-item">
                        <span style="color:#F17233">{{article.name}}
                            <small style="color:#72848B">@{{article.scrName}}</small>
                            <small style="color:#C6C6C6; padding-left:1em;">{{article.date}}</small></span>
                                <br>
                                <a style="color:#000000;" href="{{article.URL}}">{{article.Text}}</a>
                            </li>
                            <a href="" ng-show="ShowMoreButton()" ng-click="clickCategory()"
                               class="list-group-item list-group-item-warning" style="text-align: center;">더보기</a>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    keyword = "<%= key%>"
    var sentimeter = angular.module("sentimeter", ['angular-spinkit', 'chart.js']);
    //    var options = {
    //        'legend': {
    //            hrefs: []
    //        },
    //        'dataset': {
    //            title: 'Playing time per day',
    //            colorset: ['#82DCF8', '#C6C6C6', "#FE9289"],
    //        },
    //        'chartDiv': 'chart18',
    //        'chartType': 'multi_column',
    //        'chartSize': {width: 640, height: 320}
    //    };
    sentimeter.config(['ChartJsProvider', function (ChartJsProvider) {
        // Configure all charts
        ChartJsProvider.setOptions({
            colours: ['#82DCF8', '#C6C6C6', '#FE9289'],
            responsive: false
        });
        // Configure all line charts
        ChartJsProvider.setOptions('Line', {
            datasetFill: false
        });
    }])

    sentimeter.constant("articleListPageCount", 7);

    sentimeter.filter("range", function ($filter) {
        return function (data, size) {
            if (angular.isArray(data) && angular.isNumber(size)) {
                var start_index = 0;
                if (data.length < start_index) {
                    return [];
                } else {
                    return $filter("limitTo")(data.splice(start_index), size);
                }
            } else {
                return data;
            }
        }
    });

    sentimeter.controller("view", function ($scope, $http, $filter, $timeout, $interval, articleListPageCount) {
        var selectedCategory = null;
        $scope.model = {};

        $scope.keyword = keyword;

        $scope.dataExist = false;
        $scope.erroralert = false;
        $scope.getSentimentBar = false;
        $scope.getChart = false;
        $scope.getWordCount = false;

        $scope.articleSize = 7;


        $scope.height = document.body.cilentHeight;

        $scope.labels = ["", "", "", "", "", "", ""];
        $scope.series = ["긍정", "중립", "부정"];
        $scope.data = [[], [], []];


        $http.get("/result/sentimentBar?keyword=" + keyword).success(function (data) {
            $scope.model.sentiment = data;
            if (data.totalCount != 0) {
                $scope.dataExist = true;
            }
            else {
                $scope.erroralert = true;
            }
            $scope.getSentimentBar = true;
        });
        $http.get("/result/chart?keyword=" + keyword).success(function (data) {
            console.log(data);
            $scope.model.chartmake = data;
            $scope.data = $scope.model.chartmake.chartdata;
            $scope.labels = $scope.model.chartmake.chartlabels;
            $scope.series = $scope.model.chartmake.chartseries;
            $scope.getChart = true;
        });
        $http.get("/result/wordCount?keyword=" + keyword).success(function (data) {
            $scope.model.word = $filter("limitTo")(data.splice(0), 7);
            $scope.getWordCount = true;
        });
        $http.get("/result/search").success(function (data) {
            $scope.model.search = $filter("limitTo")(data.splice(0), 10);

        });

        $scope.$on('angular-spinkit:imageLoaded');

        $scope.toggle = function () {
            location.href = "/view?keyword=" + $scope.input;
        };

        $scope.categoryFilterFn = function (article) {
            return selectedCategory == null || article.sentiment == selectedCategory;
        };

        $scope.selectCategory = function (newCategory) {
            selectedCategory = newCategory;
            $scope.articleSize = 7;
        };

        $scope.clickCategory = function () {
            $scope.articleSize += 7;
        }

        $scope.ShowMoreButton = function () {
            if (selectedCategory == '긍정') {
                return $scope.articleSize < $scope.model.sentiment.positiveCount;
            }
            else if (selectedCategory == '중립') {
                return $scope.articleSize < $scope.model.sentiment.neutralCount;
            }
            else if (selectedCategory == '부정') {
                return $scope.articleSize < $scope.model.sentiment.negativeCount;
            }
            else {
                return $scope.articleSize < $scope.model.sentiment.totalCount;
            }
        }

    });

</script>
</body>
</html>
